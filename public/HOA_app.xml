<?xml version="1.0" encoding="UTF-8" ?>
<Module>
	<ModulePrefs title="HangoutConnectionApp">
		<Require feature="rpc" />
		<Require feature="views" />
		<Require feature="locked-domain" />
	</ModulePrefs>
  <Content type="html"><![CDATA[
    <html>
<head>
<style>
/* STYLING  */
  .m-bg-metal {
    color: hsla(0,0%,20%,1);
    text-shadow: hsla(0,0%,40%,.5) 0 -1px 0, hsla(0,0%,100%,.6) 0 2px 1px;

    background-color: hsl(0,0%,90%);
    box-shadow: inset hsla(0,0%,15%,  1) 0  0px 0px 4px, /* border */
      inset hsla(0,0%,15%, .8) 0 -1px 5px 4px, /* soft SD */
      inset hsla(0,0%,0%, .25) 0 -1px 0px 7px, /* bottom SD */
      inset hsla(0,0%,100%,.7) 0  2px 1px 7px, /* top HL */

      hsla(0,0%, 0%,.15) 0 -5px 6px 4px, /* outer SD */
      hsla(0,0%,100%,.5) 0  5px 6px 4px; /* outer HL */
  }

  body {
    font-family: "Droid Sans", "Lucida Sans Unicode", "Lucida Grande", Verdana, Arial, Helvetica, sans-serif;
    margin: 10px;
    padding: 10px;
  }

  .panel {
    position: relative;
    text-align: center;

    width: 100%;
    height: 100%;
    float: left;
  }

</style>

</head>
<body>

  <script src="//plus.google.com/hangouts/_/api/v1/hangout.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

  <div class='panel m-bg-metal'>
    <h3>HOA_APP<br>connection service</h3>
    <div id='main'>
    </div>
  </div>
</body>

<script>
  // Generated by CoffeeScript 1.9.2
(function() {
  var Hangout;

  Hangout = (function() {
    function Hangout(gapi1) {
      this.gapi = gapi1;
      this.status = 'started';
      this.gapi.hangout.onApiReady.add((function(_this) {
        return function() {
          return _this.gapi.hangout.onair.onBroadcastingChanged.add(_this.changeStatus);
        };
      })(this));
      setInterval(this.send_interval, 120000);
      this.notify();
    }

    Hangout.prototype.changeStatus = function(e) {
      var prev_status;
      prev_status = this.status;
      if (e.isBroadcasting) {
        if (this.status === 'started') {
          this.status = 'broadcasting';
        }
      } else {
        if (this.status === 'broadcasting') {
          this.status = 'finished';
        }
      }
      if (prev_status !== this.status) {
        $('#main').append("<p>change status: " + this.status + "</p>");
        return this.notify();
      }
    };

    Hangout.prototype.notify = function() {
      var callbackUrl, hangoutUrl, isBroadcasting, participants, startData, youTubeLiveId;
      startData = JSON.parse(this.gapi.hangout.getStartData());
      callbackUrl = startData.callbackUrl + startData.hangoutId;
      hangoutUrl = this.gapi.hangout.getHangoutUrl();
      youTubeLiveId = this.gapi.hangout.onair.getYouTubeLiveId();
      participants = this.gapi.hangout.getParticipants();
      isBroadcasting = this.gapi.hangout.onair.isBroadcasting();
      return $.ajax({
        url: callbackUrl,
        dataType: 'text',
        type: 'PUT',
        data: {
          title: startData.title,
          project_id: startData.projectId,
          event_id: startData.eventId,
          category: startData.category,
          host_id: startData.hostId,
          participants: participants,
          hangout_url: hangoutUrl,
          yt_video_id: youTubeLiveId,
          hoa_status: this.status,
          notify: true
        },
        success: function() {
          console.log('ajax.success');
          this.gapi.hangout.data.setValue('status', 'ok');
          $('#main').append("<p>ajax return: success</p>");
          if (this.gapi.hangout.data.getValue('updated') !== 'true') {
            this.gapi.hangout.layout.displayNotice('Connection to WebsiteOne established');
            return this.gapi.hangout.data.setValue('updated', 'true');
          }
        },
        error: function() {
          console.log('ajax.error');
          this.gapi.hangout.data.setValue('status', 'error');
          return $('#main').append("<p>ajax return: error</p>");
        }
      });
    };

    Hangout.prototype.send_interval = function() {
      $('#main').append("<p>2 minutes, Broadcasting: " + (this.gapi.hangout.onair.isBroadcasting()) + "</p>");
      return this.notify();
    };

    return Hangout;

  })();

  $(function() {
    return gadgets.util.registerOnLoadHandler(new Hangout(gapi));
  });

}).call(this);

</script>

]]>
</Content>
</Module>
